{"version":3,"file":"asLegacyMiddleware.cjs","sourceRoot":"","sources":["../../src/v2/asLegacyMiddleware.ts"],"names":[],"mappings":";;;AAEA,mEAK+B;AAE/B,2DAAoD;AACpD,oCAA2C;AA6B3C;;;;;;GAMG;AACH,SAAgB,kBAAkB,CAIhC,kBAEyD,EACzD,GAAG,IAA6D;IAEhE,MAAM,YAAY,GAChB,OAAO,kBAAkB,KAAK,UAAU;QACtC,CAAC,CAAC,iCAAe,CAAC,MAAM,CAAC;YACrB,UAAU,EAAE,CAAC,kBAAkB,EAAE,GAAG,IAAI,CAAC;SAC1C,CAAC,CAAC,YAAY,EAAE;QACnB,CAAC,CAAC,kBAAkB,CAAC,YAAY,EAAE,CAAC;IAExC,OAAO,IAAA,yBAAqB,EAAC,KAAK,EAAE,GAAG,EAAE,GAAG,EAAE,IAAI,EAAE,EAAE;QACpD,MAAM,OAAO,GAAG,IAAA,uCAAiB,EAAC,GAAc,CAAC,CAAC;QAClD,MAAM,OAAO,GAAG,IAAA,iCAAW,EAAC,GAAG,CAAC,CAAC;QACjC,IAAI,eAAoC,CAAC;QAEzC,MAAM,MAAM,GAAG,MAAM,YAAY,CAAC;YAChC,OAAO;YACP,OAAO;YACP,IAAI,EAAE,CAAC,YAAY,EAAE,EAAE;gBACrB,eAAe,GAAG,YAAY,CAAC;gBAC/B,OAAO,OAAO,CAAC,OAAO,CAAC,SAAS,CAAC,CAAC;YACpC,CAAC;SACF,CAAC,CAAC;QAEH,IAAI,eAAe,KAAK,SAAS,IAAI,eAAe,KAAK,OAAO,EAAE,CAAC;YACjE,MAAM,CAAC,MAAM,CAAC,GAAG,EAAE,IAAA,+BAAS,EAAC,eAAe,CAAC,CAAC,CAAC;QACjD,CAAC;QACD,IAAA,wCAAkB,EAAC,GAAG,EAAE,OAAO,CAAC,CAAC;QAEjC,IAAI,MAAM,KAAK,SAAS,EAAE,CAAC;YACzB,qEAAqE;YACrE,GAAG,CAAC,MAAM,GAAG,IAAA,+BAAS,EAAC,MAAM,CAAyC,CAAC;YACvE,OAAO,SAAS,CAAC;QACnB,CAAC;QACD,OAAO,IAAI,EAAE,CAAC;IAChB,CAAC,CAAC,CAAC;AACL,CAAC;AA1CD,gDA0CC","sourcesContent":["import type { JsonRpcParams, JsonRpcRequest } from '@metamask/utils';\n\nimport {\n  deepClone,\n  fromLegacyRequest,\n  makeContext,\n  propagateToRequest,\n} from './compatibility-utils';\nimport type { JsonRpcMiddleware, ResultConstraint } from './JsonRpcEngineV2';\nimport { JsonRpcEngineV2 } from './JsonRpcEngineV2';\nimport { createAsyncMiddleware } from '..';\nimport type { JsonRpcMiddleware as LegacyMiddleware } from '..';\n\n/**\n * Convert a {@link JsonRpcEngineV2} into a legacy middleware.\n *\n * @param engine - The engine to convert.\n * @returns The legacy middleware.\n */\nexport function asLegacyMiddleware<\n  Params extends JsonRpcParams,\n  Request extends JsonRpcRequest<Params>,\n>(\n  engine: JsonRpcEngineV2<Request>,\n): LegacyMiddleware<Params, ResultConstraint<Request>>;\n\n/**\n * Convert one or more V2 middlewares into a legacy middleware.\n *\n * @param middleware - The V2 middleware(s) to convert.\n * @returns The legacy middleware.\n */\nexport function asLegacyMiddleware<\n  Params extends JsonRpcParams,\n  Request extends JsonRpcRequest<Params>,\n>(\n  ...middleware: JsonRpcMiddleware<Request, ResultConstraint<Request>>[]\n): LegacyMiddleware<Params, ResultConstraint<Request>>;\n\n/**\n * The asLegacyMiddleware implementation.\n *\n * @param engineOrMiddleware - A V2 engine or V2 middleware.\n * @param rest - Any additional V2 middleware when the first argument is a middleware.\n * @returns The legacy middleware.\n */\nexport function asLegacyMiddleware<\n  Params extends JsonRpcParams,\n  Request extends JsonRpcRequest<Params>,\n>(\n  engineOrMiddleware:\n    | JsonRpcEngineV2<Request>\n    | JsonRpcMiddleware<Request, ResultConstraint<Request>>,\n  ...rest: JsonRpcMiddleware<Request, ResultConstraint<Request>>[]\n): LegacyMiddleware<Params, ResultConstraint<Request>> {\n  const v2Middleware =\n    typeof engineOrMiddleware === 'function'\n      ? JsonRpcEngineV2.create({\n          middleware: [engineOrMiddleware, ...rest],\n        }).asMiddleware()\n      : engineOrMiddleware.asMiddleware();\n\n  return createAsyncMiddleware(async (req, res, next) => {\n    const request = fromLegacyRequest(req as Request);\n    const context = makeContext(req);\n    let modifiedRequest: Request | undefined;\n\n    const result = await v2Middleware({\n      request,\n      context,\n      next: (finalRequest) => {\n        modifiedRequest = finalRequest;\n        return Promise.resolve(undefined);\n      },\n    });\n\n    if (modifiedRequest !== undefined && modifiedRequest !== request) {\n      Object.assign(req, deepClone(modifiedRequest));\n    }\n    propagateToRequest(req, context);\n\n    if (result !== undefined) {\n      // Unclear why the `as unknown` is needed here, but the cast is safe.\n      res.result = deepClone(result) as unknown as ResultConstraint<Request>;\n      return undefined;\n    }\n    return next();\n  });\n}\n"]}