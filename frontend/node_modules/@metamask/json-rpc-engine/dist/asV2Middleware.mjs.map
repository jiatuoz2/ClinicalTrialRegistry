{"version":3,"file":"asV2Middleware.mjs","sourceRoot":"","sources":["../src/asV2Middleware.ts"],"names":[],"mappings":"AAAA,OAAO,EAAE,cAAc,EAAE,6BAA6B;AAEtD,OAAO,EACL,WAAW,EAIZ,wBAAwB;AAQzB,OAAO,EAAE,eAAe,EAAE,8BAA0B;AAEpD,OAAO,EACL,SAAS,EACT,iBAAiB,EACjB,kBAAkB,EAClB,kBAAkB,EAClB,gBAAgB,EACjB,qCAAiC;AAmClC;;;;;;GAMG;AACH,MAAM,UAAU,cAAc,CAI5B,kBAAyE,EACzE,GAAG,IAA6C;IAEhD,MAAM,gBAAgB,GACpB,OAAO,kBAAkB,KAAK,UAAU;QACtC,CAAC,CAAC,wFAAwF;YACxF,6BAA6B;YAC7B,eAAe,CAAC,CAAC,kBAAkB,EAAE,GAAG,IAAI,CAAC,CAAC;QAChD,CAAC,CAAC,kBAAkB,CAAC,YAAY,EAAE,CAAC;IAExC,OAAO,KAAK,EAAE,EAAE,OAAO,EAAE,OAAO,EAAE,IAAI,EAAE,EAAE,EAAE;QAC1C,MAAM,GAAG,GAAG,SAAS,CAAC,OAAO,CAA2B,CAAC;QACzD,kBAAkB,CAAC,GAAG,EAAE,OAAO,CAAC,CAAC;QAEjC,MAAM,QAAQ,GAAG,MAAM,IAAI,OAAO,CAAkB,CAAC,OAAO,EAAE,EAAE;YAC9D,gEAAgE;YAChE,cAAc;YACd,MAAM,GAAG,GAAG;gBACV,OAAO,EAAE,KAAc;gBACvB,EAAE,EAAE,GAAG,CAAC,EAAE;aACQ,CAAC;YAErB,MAAM,GAAG,GAA6B,CAAC,KAAK,EAAE,EAAE;gBAC9C,IAAI,KAAK,KAAK,SAAS,EAAE,CAAC;oBACvB,GAAsB,CAAC,KAAK,GAAG,cAAc,CAAC,KAAK,CAAC,CAAC;gBACxD,CAAC;gBACD,OAAO,CAAC,GAAG,CAAC,CAAC;YACf,CAAC,CAAC;YAEF,uEAAuE;YACvE,kEAAkE;YAClE,aAAa;YACb,MAAM,UAAU,GAAG,CAAC,CAAC,EAA4B,EAAE,EAAE,CACnD,EAAE,CAAC,GAAG,CAAC,CAA8B,CAAC;YAExC,gBAAgB,CAAC,GAAG,EAAE,GAAG,EAAE,UAAU,EAAE,GAAG,CAAC,CAAC;QAC9C,CAAC,CAAC,CAAC;QACH,kBAAkB,CAAC,GAAG,EAAE,OAAO,CAAC,CAAC;QAEjC,4FAA4F;QAC5F,+FAA+F;QAC/F,oGAAoG;QACpG,IAAI,WAAW,CAAC,QAAQ,EAAE,OAAO,CAAC,IAAI,QAAQ,CAAC,KAAK,EAAE,CAAC;YACrD,MAAM,gBAAgB,CAAC,QAAQ,CAAC,KAAK,CAAC,CAAC;QACzC,CAAC;aAAM,IAAI,WAAW,CAAC,QAAQ,EAAE,QAAQ,CAAC,EAAE,CAAC;YAC3C,OAAO,QAAQ,CAAC,MAAmC,CAAC;QACtD,CAAC;QACD,OAAO,IAAI,CAAC,iBAAiB,CAAC,GAAc,CAAC,CAAC,CAAC;IACjD,CAAC,CAAC;AACJ,CAAC","sourcesContent":["import { serializeError } from '@metamask/rpc-errors';\nimport type { JsonRpcFailure, JsonRpcResponse } from '@metamask/utils';\nimport {\n  hasProperty,\n  type Json,\n  type JsonRpcParams,\n  type JsonRpcRequest,\n} from '@metamask/utils';\n\nimport type {\n  JsonRpcEngine,\n  JsonRpcEngineEndCallback,\n  JsonRpcEngineNextCallback,\n} from './JsonRpcEngine';\nimport { type JsonRpcMiddleware as LegacyMiddleware } from './JsonRpcEngine';\nimport { mergeMiddleware } from './mergeMiddleware';\nimport type { ContextConstraint, MiddlewareContext } from './v2';\nimport {\n  deepClone,\n  fromLegacyRequest,\n  propagateToContext,\n  propagateToRequest,\n  deserializeError,\n} from './v2/compatibility-utils';\nimport type {\n  // Used in docs.\n  // eslint-disable-next-line @typescript-eslint/no-unused-vars\n  JsonRpcEngineV2,\n  JsonRpcMiddleware,\n  ResultConstraint,\n} from './v2/JsonRpcEngineV2';\n\n/**\n * Convert a legacy {@link JsonRpcEngine} into a {@link JsonRpcEngineV2} middleware.\n *\n * @param engine - The legacy engine to convert.\n * @returns The {@link JsonRpcEngineV2} middleware.\n */\nexport function asV2Middleware<\n  Params extends JsonRpcParams,\n  Request extends JsonRpcRequest<Params>,\n>(engine: JsonRpcEngine): JsonRpcMiddleware<Request>;\n\n/**\n * Convert one or more legacy middleware into a {@link JsonRpcEngineV2} middleware.\n *\n * @param middleware - The legacy middleware to convert.\n * @returns The {@link JsonRpcEngineV2} middleware.\n */\nexport function asV2Middleware<\n  Params extends JsonRpcParams = JsonRpcParams,\n  Request extends JsonRpcRequest<Params> = JsonRpcRequest<Params>,\n  Result extends ResultConstraint<Request> = ResultConstraint<Request>,\n  Context extends ContextConstraint = MiddlewareContext,\n>(\n  ...middleware: LegacyMiddleware<Params, Result>[]\n): JsonRpcMiddleware<Request, Result, Context>;\n\n/**\n * The asV2Middleware implementation.\n *\n * @param engineOrMiddleware - A legacy engine or legacy middleware.\n * @param rest - Any additional legacy middleware when the first argument is a middleware.\n * @returns The {@link JsonRpcEngineV2} middleware.\n */\nexport function asV2Middleware<\n  Params extends JsonRpcParams,\n  Request extends JsonRpcRequest<Params>,\n>(\n  engineOrMiddleware: JsonRpcEngine | LegacyMiddleware<JsonRpcParams, Json>,\n  ...rest: LegacyMiddleware<JsonRpcParams, Json>[]\n): JsonRpcMiddleware<Request> {\n  const legacyMiddleware =\n    typeof engineOrMiddleware === 'function'\n      ? // mergeMiddleware uses .asMiddleware() internally, which is necessary for our purposes.\n        // See comment on this below.\n        mergeMiddleware([engineOrMiddleware, ...rest])\n      : engineOrMiddleware.asMiddleware();\n\n  return async ({ request, context, next }) => {\n    const req = deepClone(request) as JsonRpcRequest<Params>;\n    propagateToRequest(req, context);\n\n    const response = await new Promise<JsonRpcResponse>((resolve) => {\n      // The result or error property will be set by the legacy engine\n      // middleware.\n      const res = {\n        jsonrpc: '2.0' as const,\n        id: req.id,\n      } as JsonRpcResponse;\n\n      const end: JsonRpcEngineEndCallback = (error) => {\n        if (error !== undefined) {\n          (res as JsonRpcFailure).error = serializeError(error);\n        }\n        resolve(res);\n      };\n\n      // We know from the implementation of JsonRpcEngine.asMiddleware() that\n      // legacyNext will always be passed a callback, so cb can never be\n      // undefined.\n      const legacyNext = ((cb: JsonRpcEngineEndCallback) =>\n        cb(end)) as JsonRpcEngineNextCallback;\n\n      legacyMiddleware(req, res, legacyNext, end);\n    });\n    propagateToContext(req, context);\n\n    // Mimic the behavior of JsonRpcEngine.#handle(), which only treats truthy errors as errors.\n    // Legacy middleware may violate the invariant that response objects have either a result or an\n    // error property. In practice, we may see response objects with results and `{ error: undefined }`.\n    if (hasProperty(response, 'error') && response.error) {\n      throw deserializeError(response.error);\n    } else if (hasProperty(response, 'result')) {\n      return response.result as ResultConstraint<Request>;\n    }\n    return next(fromLegacyRequest(req as Request));\n  };\n}\n"]}